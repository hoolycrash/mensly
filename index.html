<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
    <meta name="apple-mobile-web-app-title" content="Mensly">
    <meta name="description" content="Speisepläne und Mensafinder. Interaktive Zusammenstellung aller Speisepläne der Mensen des Studentenwerk Dresdens.">
    <meta name="keywords" content="speiseplan, mensa, dresden, tudresden, tu dresden, mensa speiseplan, mensaspeiseplan, mensly, mensafinder, studentenwerk dresden">

    <title>Mensly</title>

    <link rel="icon" type="image/x-icon" href="./assets/favicon.ico">
    <link rel="stylesheet" href="./assets/css/styles.css">
    <link rel="stylesheet" href="./assets/css/dark_styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=arrow_back,arrow_forward,menu_book_2,near_me,settings" rel="stylesheet" />
    <link rel="manifest" href="manifest.json" type="application/json">
    
    <script>let thissite = 'Speiseplan';</script>
    <script src="./assets/src/menu.js"></script>
    <script src="./assets/src/workers.js"></script>

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Speisepläne und Mensafinder - Dresden - Mensly">
    <meta property="og:description" content="Speisepläne und Mensafinder. Interaktive Zusammenstellung aller Speisepläne der Mensen des Studentenwerk Dresdens.">
    <meta property="og:image" content="https://mensly.unibits.eu/assets/branding/icon-512x512.png">
    <meta property="og:url" content="https://mensly.unibits.eu">
    <meta property="og:type" content="website">

    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Speisepläne und Mensafinder - Dresden - Mensly">
    <meta name="twitter:description" content="Speisepläne und Mensafinder. Interaktive Zusammenstellung aller Speisepläne der Mensen des Studentenwerk Dresdens.">
    <meta name="twitter:image" content="https://mensly.unibits.eu/assets/branding/bigbanner.png">
    <meta name="twitter:url" content="https://mensly.unibits.eu">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Schema.org Markup -->
    <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "WebSite",
            "name": "Mensly",
            "url": "https://mensly.unibits.eu",
            "description": "Speisepläne und Mensafinder für Dresden",
        }
    </script>

</head>
<body>
    <div class="controls">
        <center>
            <div class="island">
                <button onclick="changeDate(-1)" class="material-symbols-outlined railingicon">arrow_back</button>
                <input type="date" id="datePicker">
                <button onclick="changeDate(1)" class="material-symbols-outlined railingicon">arrow_forward</button>
            </div>
        </center>
    </div>
    <div id="detailOverlay" class="hidden">
        <div id="detailContent">
            <span class="close-btn" onclick="closeDetails()">Fertig</span>
            <div id="mealDetails"></div>
        </div>
    </div>

    <div class="nav-rail" id="navrail"></div>

    <center>

        <div class="content"></div>

        <div class="borderlesscontent">
            <div id="app"></div>
            <br><br><br><br>
        </div>

    </center>

   
<script>
    const menses = [
        { id: 4, name: "Alte Mensa", city: "Dresden" },
        { id: 6, name: "Matrix", city: "Dresden" },
        { id: 8, name: "Mensologie", city: "Dresden" },
        { id: 9, name: "Siedepunkt", city: "Dresden" },
        { id: 10, name: "TellerRandt", city: "Tharandt" },
        { id: 11, name: "Palucca-Hochschule", city: "Dresden" },
        { id: 13, name: "Stimm-Gabel", city: "Dresden" },
        { id: 24, name: "Kraatschn", city: "Zittau" },
        { id: 25, name: "Mahlwerk", city: "Zittau" },
        { id: 28, name: "MiO Mensa im Osten", city: "Görlitz" },
        { id: 29, name: "U-Boot", city: "Dresden" },
        { id: 32, name: "Johanna", city: "Dresden"},
        { id: 33, name: "WUeins", city: "Dresden"},
        { id: 34, name: "Brühl", city: "Dresden"},
        { id: 35, name: "Zeltschlösschen", city: "Dresden"},
    ];

    const datePicker = document.getElementById('datePicker');
    const app = document.getElementById('app');
    const overlay = document.getElementById('detailOverlay');
    const detailBox = document.getElementById('mealDetails');

    //Set Today
    datePicker.value = new Date().toISOString().split('T')[0];
    datePicker.addEventListener('change', fetchAllMeals);

    overlay.addEventListener('click', (e) => { if(e.target === overlay) closeDetails(); });

    function closeDetails() { overlay.classList.add('closehidden'); }

    function getFavorites() {
        const favs = localStorage.getItem('favmensa');
        return favs ? JSON.parse(favs) : [];
    }

    function toggleFav(id) {
        let favs = getFavorites();
        if (favs.includes(id)) {
            favs = favs.filter(f => f !== id);
        } else {
            favs.push(id);
        }
        localStorage.setItem('favmensa', JSON.stringify(favs));
        fetchAllMeals(); 
    }

    function showDetails(mealJson) {
        const meal = JSON.parse(decodeURIComponent(mealJson));
        const isPersonal = localStorage.getItem("priceswitch") === "true";
        const isImageblock = localStorage.getItem("imageswitch") === "true";
        const isVegan = meal.notes.some(n => n.toLowerCase().includes("vegan") || n.toLowerCase().includes("vegan"));
        const isVeggie = meal.notes.some(n => n.toLowerCase().includes("vegetarisch") || n.toLowerCase().includes("vegetarisch"));
        const isPig = meal.notes.some(n => n.toLowerCase().includes("schweinefleisch") || n.toLowerCase().includes("schweinefleisch"));
        const isCow = meal.notes.some(n => n.toLowerCase().includes("rindfleisch") || n.toLowerCase().includes("rindfleisch"));
        const isFish = meal.notes.some(n => n.toLowerCase().includes("fisch"));
        const isGeflugel = meal.name.toLowerCase().includes("geflügel") || meal.name.toLowerCase().includes("ente") || meal.name.toLowerCase().includes("pute") || meal.name.toLowerCase().includes("Hähnchen");
        const isSoldout = meal.soldout;
        
        detailBox.innerHTML = `
        <div class="popupimage" style="background-image: url('https:${isImageblock ? "" : !meal.image.includes("studentenwerk-dresden-lieber-mensen-gehen.jpg")? `${meal.image.trim()}`: ""}')"">
            <b class="accent">${(meal.category.includes("Abendangebot") ? "Abendangebot" : meal.category)}</b>
            <h2>${(meal.name.replace(/\s*( mit| aus | auf| an| dazu).*/i, "").trim().replace(/\s*\([^)]*\)/g, ""))}</h2>
            ${((meal.name.match(/\b(?:mit|aus|auf|an|dazu)\s+(.*)/i) || ["", ""])[1].trim()).replace(/\s*\([^)]*\)/g, "")}
            <br><br>
            ${isVeggie ? '<img src="./assets/icons/veggie.svg" class="badge">' : ''}
            ${isPig ? '<img src="./assets/icons/pig.svg" class="badge">' : ''}
            ${isCow ? '<img src="./assets/icons/cow.svg" class="badge">' : ''}
            ${isVegan ? '<img src="./assets/icons/vegan.svg" class="badge">' : ''}
            ${isFish ? '<img src="./assets/icons/fish.svg" class="badge">' : ''}
            ${isGeflugel ? '<img src="./assets/icons/geflugel.svg" class="badge">' : ''}
        </div>
        <div class="bigprice ${isSoldout ? 'bigpriceAUSVERKAUFT' : ''}">
            ${isSoldout ? 'AUSVERKAUFT<br>' : ''}
            <b>${isSoldout ? '<s>' : ''}${isPersonal ? meal.prices.Bedienstete.toFixed(2) : meal.prices.Studierende.toFixed(2)}€${isSoldout ? '</s>' : ''}</b><br>
            <span class="right">${isPersonal ? "Studi" : "Personal"} : ${isSoldout ? '<s>' : ''}${isPersonal ? meal.prices.Studierende.toFixed(2) : meal.prices.Bedienstete.toFixed(2)}€${isSoldout ? '</s>' : ''}<br>
            </span>
        </div>
        <div class="popupcontent">
            <p><strong>Zusatzinfos:</strong></p>
            <ul class="smallprint">${meal.notes.map(n => `<li>${n}</li>`).join('')}</ul>
        </div>
        `;

        overlay.classList.remove('hidden')
        overlay.classList.remove('closehidden');
    }

    async function fetchAllMeals() {
        const date = datePicker.value;
        app.innerHTML = '<center><img src="./assets/spinners/pulserings.svg" class="spinner">';
        const isPersonal = localStorage.getItem("priceswitch") === "true";
        const isImageblock = localStorage.getItem("imageswitch") === "true";
        const isSouldoutblock = localStorage.getItem("souldoutswitch") === "true";
        const isVeganonly = localStorage.getItem("veganswitch") === "true";
        
        const favs = getFavorites();
        
        const sortedMenses = [...menses].sort((a, b) => {
            const aFav = favs.includes(a.id);
            const bFav = favs.includes(b.id);
            return bFav - aFav; 
        });

        let htmlContent = '';

        for (const mensa of sortedMenses) {
            const isFav = favs.includes(mensa.id);
            try {
                const response = await fetch(`https://api.studentenwerk-dresden.de/openmensa/v2/canteens/${mensa.id}/days/${date}/meals`);
                const meals = await response.json();
                
                htmlContent += `
                    <div class="mensa-container">
                        <div class="mensa-header">
                            <center>
                                <div class="h1content">
                                    <div class="mensacard">
                                        <b>${mensa.name}</b><br>
                                        <small>${mensa.city}</small>
                                        <div class="favbox">
                                        <button class="fav-btn ${isFav ? 'active' : ''}" onclick="toggleFav(${mensa.id})">
                                            ${isFav ? '★' : '☆'}
                                        </button>   
                                        </div> 
                                    </div>    
                                </div>
                            </center>
                        </div>
                        <div class="meal-container">
                `;

                if (meals.length === 0) {
                    htmlContent += `<div class="meal">Geschlossen</div></div></div>`;
                } else {
                    meals.forEach(meal => {
                        const cleanName = meal.name.replace(/\s*\([^)]*\)/g, "");
                        const isVegan = meal.notes.some(n => n.toLowerCase().includes("vegan") || n.toLowerCase().includes("vegan"));
                        const isVeggie = meal.notes.some(n => n.toLowerCase().includes("veggie") || n.toLowerCase().includes("vegetarisch"));
                        const isPig = meal.notes.some(n => n.toLowerCase().includes("schweinefleisch") || n.toLowerCase().includes("schweinefleisch"));
                        const isCow = meal.notes.some(n => n.toLowerCase().includes("rindfleisch") || n.toLowerCase().includes("rindfleisch"));
                        const isFish = meal.notes.some(n => n.toLowerCase().includes("fisch"));
                        const isGeflugel = meal.name.toLowerCase().includes("geflügel") || meal.name.toLowerCase().includes("ente") || meal.name.toLowerCase().includes("pute") || meal.name.toLowerCase().includes("Hähnchen");
                        const isSoldout = meal.soldout;

                        const mealData = encodeURIComponent(JSON.stringify(meal));

                        if (isSoldout && isSouldoutblock) return

                        if (isVeganonly && !isVegan) return

                        htmlContent += `
                            <div class="meal ${isSoldout ? 'AUSVERKAUFT' : ''}" onclick="showDetails('${mealData}')">
                                <span class="chip">&nbsp;${(meal.category.includes("Abendangebot") ? "Abendangebot" : meal.category)}&nbsp;</span><br><br>
                                <b>${cleanName.replace(/\s*( mit| aus| auf| an| dazu).*/i, "").trim()}</b><br>
                                ${(cleanName.match(/\b(?:mit|aus|auf|an|dazu)\s+(.*)/i) || ["", ""])[1].trim()} <br>
                                <div class="badgebox">
                                    ${isVeggie ? '<img src="./assets/icons/veggie.svg" class="badge">' : ''}
                                    ${isPig ? '<img src="./assets/icons/pig.svg" class="badge">' : ''}
                                    ${isCow ? '<img src="./assets/icons/cow.svg" class="badge">' : ''}
                                    ${isVegan ? '<img src="./assets/icons/vegan.svg" class="badge">' : ''}
                                    ${isFish ? '<img src="./assets/icons/fish.svg" class="badge">' : ''}
                                    ${isGeflugel ? '<img src="./assets/icons/geflugel.svg" class="badge">' : ''}
                                </div>
                                
                                ${!meal.image.includes("studentenwerk-dresden-lieber-mensen-gehen.jpg") 
                                ? `<br><br><br><img src="https:${isImageblock ? "//mensly.unibits.eu/none.png": meal.image.trim()}" class="mealimage">` 
                                : ""}
                                <br><br><br>
                                <div class="price">
                                    <div class="pricetag ${isSoldout ? 'AUSVERKAUFT' : ''}">
                                        ${isSoldout ? '<small>AUSVERKAUFT</small><br>' : ''}${isSoldout ? '<s>' : ''}${isPersonal ? meal.prices.Bedienstete.toFixed(2) : meal.prices.Studierende.toFixed(2)}€${isSoldout ? '</s>' : ''}<br><small>${isPersonal ? "Personal" : "Studi"}</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                htmlContent += `
                        </div>
                    </div>
                `;

            } catch (err) {
                htmlContent += `
                    <div class="meal">Dienst nicht erreichbar.</div></div></div>     
                   `;
            }
        }

        app.innerHTML = htmlContent;
    }

    function changeDate(days) {
        const currentDate = new Date(datePicker.value);
        currentDate.setDate(currentDate.getDate() + days);
        datePicker.value = currentDate.toISOString().split('T')[0];
        fetchAllMeals();
    }

    fetchAllMeals();
</script>

<br><br><br><br><br>

</body>
</html>
